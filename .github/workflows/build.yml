name: Build LARS Plugin

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: windows-2025

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Download LibTorch
        shell: pwsh
        run: |
          # Download LibTorch (CPU version for Windows)
          Invoke-WebRequest -Uri "https://download.pytorch.org/libtorch/cpu/libtorch-win-shared-with-deps-2.1.0%2Bcpu.zip" -OutFile libtorch.zip
          
          # Extract
          Expand-Archive libtorch.zip -DestinationPath C:\LT_TEMP
          
          # Move to C:\libtorch
          Move-Item -Path C:\LT_TEMP\libtorch -Destination C:\libtorch

      - name: Download JUCE
        shell: pwsh
        run: |
          # Clone JUCE to C:\JUCE
          git clone --depth 1 https://github.com/juce-framework/JUCE.git C:\JUCE

      - name: Patch CMakeLists.txt
        shell: pwsh
        run: |
          $cmakePath = "drums_demix/CMakeLists.txt"
          $content = Get-Content $cmakePath -Raw
          
          # 1. Force C++17 for LibTorch compatibility
          $content = $content -replace 'project\(', "set(CMAKE_CXX_STANDARD 17)`nset(CMAKE_CXX_STANDARD_REQUIRED ON)`nproject("

          # 2. Fix LibTorch Path
          $content = $content -replace 'set\(CMAKE_PREFIX_PATH "INSERT YOUR PATH TO LIBTORCH"\)', 'set(CMAKE_PREFIX_PATH "C:/libtorch")'
          
          # 3. Fix JUCE Path
          $content = $content -replace 'add_subdirectory\(INSERT YOUR PATH TO JUCE \./JUCE\)', 'add_subdirectory("C:/JUCE" ./JUCE)'

          # 4. Fix the Post-Build DLL Copy Path
          # This replaces the empty variable with the actual install path
          $content = $content -replace '\$\{TORCH_INSTALL_PREFIX\}', 'C:/libtorch'
          
          # 5. Add /bigobj flag (Required for heavy LibTorch/JUCE builds)
          if ($content -notlike "*target_compile_options*") {
              $content += "`nadd_compile_options(/bigobj)"
          }

          Set-Content -Path $cmakePath -Value $content
          
          # Verify the first few lines to ensure C++17 is set
          Get-Content $cmakePath | Select-Object -First 10

      - name: Configure CMake
        shell: pwsh
        run: |
          # Now we can run CMake. We point -B to build and -S to the source folder (drums_demix)
          cmake -S drums_demix -B build -G "Visual Studio 17 2022"

      - name: Build Plugin
        shell: pwsh
        run: |
          cmake --build build --config Release --parallel

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: LARS-Plugin
          path: |
            build/LARS_artefacts/Release/VST3/*.vst3
            build/LARS_artefacts/Release/Standalone/*.exe
