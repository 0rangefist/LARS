name: Build LARS Plugin

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: windows-2025

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Download LibTorch
        shell: pwsh
        run: |
          # Download LibTorch (CPU version for Windows)
          Invoke-WebRequest -Uri "https://download.pytorch.org/libtorch/cpu/libtorch-win-shared-with-deps-2.1.0%2Bcpu.zip" -OutFile libtorch.zip
          
          # Extract
          Expand-Archive libtorch.zip -DestinationPath C:\LT_TEMP
          
          # Move to C:\libtorch
          Move-Item -Path C:\LT_TEMP\libtorch -Destination C:\libtorch

      - name: Download JUCE
        shell: pwsh
        run: |
          # Clone JUCE to C:\JUCE
          git clone --depth 1 https://github.com/juce-framework/JUCE.git C:\JUCE

      - name: Patch CMakeLists.txt
        shell: pwsh
        run: |
          $cmakePath = "drums_demix/CMakeLists.txt"
          
          # 1. Read the file content
          $content = Get-Content $cmakePath -Raw
          
          # 2. Force C++17 at the top (Fixes the test_nn error)
          $content = "set(CMAKE_CXX_STANDARD 17)`nset(CMAKE_CXX_STANDARD_REQUIRED ON)`n" + $content
          
          # 3. Fix LibTorch Path
          $content = $content -replace 'set\(CMAKE_PREFIX_PATH "INSERT YOUR PATH TO LIBTORCH"\)', 'set(CMAKE_PREFIX_PATH "C:/libtorch")'
          
          # 4. Fix JUCE Path
          $content = $content -replace 'add_subdirectory\(INSERT YOUR PATH TO JUCE \./JUCE\)', 'add_subdirectory("C:/JUCE" ./JUCE)'

          # 5. Fix the "Post-Build" DLL Copy Path (Fixes the Exit Code 1)
          $content = $content -replace '\$\{TORCH_INSTALL_PREFIX\}', 'C:/libtorch'

          # 6. Suppress warnings and add /bigobj
          $content = $content -replace 'set\(CMAKE_CXX_FLAGS "\$\{CMAKE_CXX_FLAGS\} \$\{TORCH_CXX_FLAGS\}"\)', 'set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} ${TORCH_CXX_FLAGS} /wd4244 /wd4702 /bigobj")'
          
          # Write the changes back to the file
          Set-Content -Path $cmakePath -Value $content
          
          # Verify the first 40 lines
          Get-Content $cmakePath | Select-Object -First 40

      - name: Configure CMake
        shell: pwsh
        run: |
          # Now we can run CMake. We point -B to build and -S to the source folder (drums_demix)
          cmake -S drums_demix -B build -G "Visual Studio 17 2022"

      - name: Build Plugin
        shell: pwsh
        run: |
          cmake --build build --config Release --parallel

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: LARS-Plugin
          path: |
            build/LARS_artefacts/Release/VST3/*.vst3
            build/LARS_artefacts/Release/Standalone/*.exe
