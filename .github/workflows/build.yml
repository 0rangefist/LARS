name: Build LARS Windows
on: [push, workflow_dispatch]

jobs:
  build:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: 'recursive'

      - name: Install Dependencies
        shell: pwsh
        run: |
          # Download LibTorch
          Invoke-WebRequest -Uri "https://download.pytorch.org/libtorch/cpu/libtorch-win-shared-with-deps-2.1.0%2Bcpu.zip" -OutFile libtorch.zip
          
          # Extract to a specific folder
          Expand-Archive libtorch.zip -DestinationPath C:\LT_TEMP
          
          # Move it to a clean path C:\libtorch
          Move-Item -Path C:\LT_TEMP\libtorch -Destination C:\libtorch
          
          # Download JUCE
          git clone --depth 1 https://github.com/juce-framework/JUCE.git C:\JUCE

      - name: Configure CMake
        shell: pwsh
        run: |
          # We define JUCE_DIR and also pass it as a hint to CMake
          cmake -S drums_demix -B build -G "Visual Studio 17 2022" `
          -DTorch_DIR="C:/libtorch/share/cmake/Torch" `
          -DJUCE_DIR="C:/JUCE" `
          -Djuce_PATH="C:/JUCE"

      - name: Build
        run: cmake --build build --config Release --target LARS_VST3

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: LARS-Windows-VST3
          path: build/LARS_Artifacts/Release/VST3/LARS.vst3
