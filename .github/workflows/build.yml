name: Build LARS Plugin

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: windows-2025

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Download LibTorch
        shell: pwsh
        run: |
          # Download LibTorch (CPU version for Windows)
          Invoke-WebRequest -Uri "https://download.pytorch.org/libtorch/cpu/libtorch-win-shared-with-deps-2.1.0%2Bcpu.zip" -OutFile libtorch.zip
          
          # Extract
          Expand-Archive libtorch.zip -DestinationPath C:\LT_TEMP
          
          # Move to C:\libtorch
          Move-Item -Path C:\LT_TEMP\libtorch -Destination C:\libtorch

      - name: Download JUCE
        shell: pwsh
        run: |
          # Clone JUCE to C:\JUCE
          git clone --depth 1 https://github.com/juce-framework/JUCE.git C:\JUCE

      - name: Patch CMakeLists.txt
        shell: pwsh
        run: |
          $cmakePath = "drums_demix/CMakeLists.txt"
          
          # 1. Define the Global Settings we need
          $globalSettings = @"
          set(CMAKE_CXX_STANDARD 17)
          set(CMAKE_CXX_STANDARD_REQUIRED ON)
          if(MSVC)
            add_compile_options(/bigobj /wd4244 /wd4702)
            add_definitions(-D_SILENCE_ALL_CXX17_DEPRECATION_WARNINGS)
          endif()
          "@
      
          # 2. Read the current file
          $content = Get-Content $cmakePath -Raw
          
          # 3. Inject global settings at the very top
          $content = $globalSettings + "`n" + $content
      
          # 4. Fix the Hardcoded Paths
          $content = $content -replace 'set\(CMAKE_PREFIX_PATH "INSERT YOUR PATH TO LIBTORCH"\)', 'set(CMAKE_PREFIX_PATH "C:/libtorch")'
          $content = $content -replace 'add_subdirectory\(INSERT YOUR PATH TO JUCE \./JUCE\)', 'add_subdirectory("C:/JUCE" ./JUCE)'
          
          # 5. Fix the Post-Build DLL Copy
          $content = $content -replace '\$\{TORCH_INSTALL_PREFIX\}', 'C:/libtorch'
          
          # 6. FIX THE test_nn C++ STANDARD - Change from 14 to 17
          $content = $content -replace 'set_property\(TARGET test_nn PROPERTY CXX_STANDARD 14\)', 'set_property(TARGET test_nn PROPERTY CXX_STANDARD 17)'
      
          # 7. Save and Verify
          Set-Content -Path $cmakePath -Value $content
          Write-Host "--- Last 15 lines of patched file ---"
          Get-Content $cmakePath | Select-Object -Last 15

      - name: Configure CMake
        shell: pwsh
        run: |
          # Now we can run CMake. We point -B to build and -S to the source folder (drums_demix)
          cmake -S drums_demix -B build -G "Visual Studio 17 2022"

      - name: Build Plugin
        shell: pwsh
        run: |
          cmake --build build --config Release --parallel

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: LARS-Plugin
          path: |
            build/LARS_artefacts/Release/VST3/*.vst3
            build/LARS_artefacts/Release/Standalone/*.exe
